<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard | Health Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font and base styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6; /* Light, calming background */
            color: #1e293b;
        }

        /* Gradient for the main greeting card */
        .greeting-card {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            /* Indigo gradient */
            color: white;
            transition: all 0.3s ease;
        }

        /* General action card styling for a commercial look */
        .action-card {
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            /* Soft shadow */
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        /* Specific card colors */
        .card-blue {
            background-color: #eff6ff;
            border-left: 5px solid #3b82f6;
        }

        .card-green {
            background-color: #ecfdf5;
            border-left: 5px solid #10b981;
        }

        .card-purple {
            background-color: #f5f3ff;
            border-left: 5px solid #8b5cf6;
        }
    </style>
</head>

<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">

        <!-- Personalized Header & Logout -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-gray-200">
            <div class="mb-4 sm:mb-0">
                <h1 class="text-4xl font-extrabold text-gray-900">
                    Hello, <span id="patient-name-display" class="text-indigo-600">Guest</span>
                </h1>
                <p class="text-lg text-gray-500 mt-1">Your comprehensive health dashboard awaits.</p>
            </div>
            <button id="logout-button"
                class="bg-red-500 text-white font-semibold px-6 py-2 rounded-full hover:bg-red-600 transition shadow-lg flex items-center">
                <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                Logout
            </button>
        </header>

        <!-- Main Greeting Card (Quick Status/CTA) -->
        <div class="greeting-card p-6 sm:p-8 rounded-xl shadow-2xl mb-10">
            <div class="flex items-center space-x-4">
                <i data-lucide="heart-handshake" class="w-10 h-10 text-white flex-shrink-0"></i>
                <div>
                    <h2 class="text-2xl font-bold">Welcome Back to MediConnect</h2>
                    <p class="text-indigo-200 mt-1">You are one step closer to your next consultation. Use the links below to manage your journey.</p>
                </div>
            </div>
        </div>

        <!-- Core Service Navigation Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- 1. Find a Doctor / Book New -->
            <a href="/search"
                class="action-card card-blue p-6 rounded-xl flex flex-col justify-between h-full">
                <div class="flex items-center mb-4 space-x-4">
                    <i data-lucide="stethoscope" class="w-8 h-8 text-blue-600"></i>
                    <h3 class="text-2xl font-bold text-blue-800">Book New Appointment</h3>
                </div>
                <p class="text-gray-700 mb-4">
                    Instantly search for specialists and book a consultation based on real-time availability.
                </p>
                <div class="flex items-center text-blue-600 font-semibold mt-auto">
                    Search & Book &rarr;
                </div>
            </a>

            <!-- 2. My Appointments -->
            <a href="/patient/appointments"
                class="action-card card-green p-6 rounded-xl flex flex-col justify-between h-full">
                <div class="flex items-center mb-4 space-x-4">
                    <i data-lucide="calendar-check" class="w-8 h-8 text-green-600"></i>
                    <h3 class="text-2xl font-bold text-green-800">My Appointments</h3>
                </div>
                <p class="text-gray-700 mb-4">
                    Review your upcoming visits, check past appointment history, and manage cancellations.
                </p>
                <div class="flex items-center text-green-600 font-semibold mt-auto">
                    View & Manage &rarr;
                </div>
            </a>

            <!-- 3. Health Profile / Records -->
            <a href="/patient/profile"
                class="action-card card-purple p-6 rounded-xl flex flex-col justify-between h-full">
                <div class="flex items-center mb-4 space-x-4">
                    <i data-lucide="file-text" class="w-8 h-8 text-purple-600"></i>
                    <h3 class="text-2xl font-bold text-purple-800">Health Profile & Records</h3>
                </div>
                <p class="text-gray-700 mb-4">
                    Update personal information, review your medical history, and manage medications.
                </p>
                <div class="flex items-center text-purple-600 font-semibold mt-auto">
                    Update Details &rarr;
                </div>
            </a>

        </div>
    </div>

    <!-- Script for Logout and Dynamic Content -->
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // --- 1. SIMULATED USER DATA LOADING (Replace with actual API call) ---
        const fetchPatientName = async () => {
            const nameElement = document.getElementById('patient-name-display');
            if (!nameElement) return;

            try {
                // IMPORTANT: Use the new backend endpoint protected by verifyJWT
                const response = await fetch('/api/patient/me/name', {
                    method: 'GET',
                    credentials: 'include', // Ensures the access token cookie is sent
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.Name) {
                    // Update the greeting with the fetched name
                    nameElement.textContent = data.Name;
                } else {
                    // Fallback if data structure is missing but fetch was okay
                    nameElement.textContent = 'User';
                    console.warn("Patient name found but incomplete data received.");
                }

            } catch (error) {
                console.error('Error fetching patient name:', error);
                nameElement.textContent = 'Guest'; // Set a default on failure
            }
        };

        // --- 2. LOGOUT FUNCTION ---
        const handleLogout = async () => {
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.disabled = true; // Disable button to prevent multiple clicks
                logoutButton.innerHTML = '<i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin"></i> Logging Out...';
                lucide.createIcons();
            }
            
            try {
                // Assuming your backend /logout route clears the HTTP-only cookie
                const response = await fetch('/logout', {
                    method: 'POST',
                    credentials: 'include',
                });

                let result = {};
                try {
                    result = await response.json();
                } catch (e) {
                    // Handle non-JSON response (e.g., redirect middleware triggered)
                    console.warn("Logout response was not JSON. Assuming success/redirect.");
                    window.location.replace('/');
                    return;
                }
                

                if (response.ok && result.success) {
                    console.log(result.message);
                    // Redirect to the home page or login page after successful logout
                    window.location.replace( '/');
                } else {
                    // Display error in a non-alert box later; using console for now.
                    console.error(`Logout failed: ${result.message || 'Server error.'}`);
                    alert(`Logout failed: ${result.message || 'Server error.'}`);
                }
            } catch (error) {
                console.error('Network error during logout:', error);
                alert('A network error prevented logout. Please try again.');
            } finally {
                if (logoutButton) {
                    logoutButton.disabled = false;
                    logoutButton.innerHTML = '<i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Logout';
                    lucide.createIcons();
                }
            }
        };

        // Attach event listener to the logout button after script definition
        document.addEventListener('DOMContentLoaded', () => {
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }
        });
        fetchPatientName();
    </script>
</body>

</html>
